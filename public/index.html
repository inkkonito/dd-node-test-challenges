<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- DataDome JS Tag -->
    <script>
      window.ddjskey = '5937CB836686F83D473E0A7011FA0E';
      window.ddoptions = { ajaxListenerPath: true, ajaxListenerPathDepth: 2 };
    </script>
    <script src="https://js.datadome.co/tags.js" async></script>

    <title>DataDome Protected Page</title>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900">
    <main class="mx-auto max-w-4xl p-8">
      <!-- Header -->
      <header class="mb-8 text-center">
        <h1 class="text-4xl font-extrabold text-blue-700">DataDome Protection Demo</h1>
        <p class="mt-2 text-lg text-slate-600">This page is protected by DataDome (server + client).</p>
      </header>

      <!-- Cards row -->
      <section class="grid md:grid-cols-2 gap-6">
        <!-- Cookie Viewer (dynamic) -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h2 class="text-xl font-semibold mb-3">DataDome Cookie (full value)</h2>
          <pre id="cookieBox" class="bg-slate-100 p-3 rounded overflow-x-auto text-sm">(No datadome cookie set)</pre>
          <button
            id="removeCookieBtn"
            class="mt-3 rounded bg-red-600 px-3 py-1.5 text-white hover:bg-red-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Remove Cookie
          </button>
        </div>

        <!-- Client-side code snippet used on this page -->
        <div class="bg-white p-6 rounded-xl shadow">
          <h2 class="text-xl font-semibold mb-3">Client-side Integration Snippet</h2>
          <pre class="bg-slate-100 p-3 rounded overflow-x-auto text-sm">
&lt;script&gt;
  window.ddjskey = '5937CB836686F83D473E0A7011FA0E';
  window.ddoptions = { ajaxListenerPath: true, ajaxListenerPathDepth: 2 };
&lt;/script&gt;
&lt;script src="https://js.datadome.co/tags.js" async&gt;&lt;/script&gt;
          </pre>
        </div>
      </section>

      <!-- Actions -->
      <section class="mt-10">
        <h2 class="text-2xl font-semibold mb-4">Test Endpoints</h2>
        <div class="space-x-4">
          <button
            id="xhrButton"
            type="button"
            class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            Trigger XHR to /any-xhr
          </button>
          <a
            href="/any-document"
            class="rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700 inline-block"
          >
            Navigate to /any-document
          </a>
        </div>

        <!-- XHR Output -->
        <div id="output" class="mt-6 p-4 border rounded bg-white shadow text-sm"></div>
      </section>

      <!-- Triggers info -->
      <section class="mt-10 bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold mb-3">Challenge triggers (set request header)</h2>
        <p class="text-slate-700 mb-3">
          Set your <span class="font-semibold">User-Agent</span> header (using devTools) to the following values to trigger challenges:
        </p>
        <ul class="list-disc pl-6 space-y-1 text-slate-800">
          <li><code>BLOCKUA</code> → CAPTCHA</li>
          <li><code>BLOCKUA-HARDBLOCK</code> → CAPTCHA then HARDBLOCK</li>
          <li><code>DeviceCheckTestUA</code> → DeviceCheck</li>
          <li><code>DeviceCheckTestUA-BLOCKUA</code> → DeviceCheck then CAPTCHA</li>
          <li><code>DeviceCheckTestUA-HARDBLOCK</code> → DeviceCheck then HARDBLOCK</li>
          <li><code>HARDBLOCKUA</code> → HARDBLOCK</li>
          <li><code>HARDBLOCK_UA</code> → HARDBLOCK on XHR on Cross-Domain</li>
        </ul>
      </section>
    </main>

    <!-- Minimal scripts -->
    <script>
      // --- Cookie helpers ---
      function parseCookieString(s) {
        const out = {};
        (s || "").split(";").forEach((part) => {
          const [k, ...rest] = part.trim().split("=");
          if (!k) return;
          out[k] = rest.join("=");
        });
        return out;
      }
      function getDatadomeCookie() {
        const c = parseCookieString(document.cookie).datadome;
        return c ? decodeURIComponent(c) : "";
      }

      // Update the cookie panel and button state
      function updateCookiePanel() {
        const val = getDatadomeCookie();
        const box = document.getElementById("cookieBox");
        const btn = document.getElementById("removeCookieBtn");
        if (val) {
          box.textContent = val;
          btn.disabled = false;
        } else {
          box.textContent = "(No datadome cookie set)";
          btn.disabled = true;
        }
      }

      // Robust cookie removal (common domain/path combos)
      function removeCookie() {
        const name = "datadome";
        const expires = "Thu, 01 Jan 1970 00:00:00 GMT";
        const host = location.hostname;
        const del = (domain, path) => {
          document.cookie =
            `${name}=; Expires=${expires}; Max-Age=0; Path=${path}` +
            (domain ? `; Domain=${domain}` : "") +
            (location.protocol === "https:" ? "; Secure" : "") +
            "; SameSite=Lax";
        };
        const bare = host.replace(/^www\./, "");
        const domains = ["", host, `.${host}`, bare !== host ? bare : "", bare !== host ? `.${bare}` : ""].filter(Boolean);
        const pathParts = location.pathname.split("/").filter(Boolean);
        const paths = ["/", `/${pathParts.slice(0, -1).join("/")}` || "/"];
        for (const d of domains) for (const p of paths) del(d, p);
        updateCookiePanel();
      }

      // Render headers (keys blue, values dark)
      function renderHeaders(obj) {
        return Object.entries(obj || {})
          .map(([k, v]) => `<div><span class="text-blue-700 font-semibold">${k}:</span> <span class="text-slate-800 break-all">${v}</span></div>`)
          .join("");
      }

      // Briefly poll to catch cookie updates set right after the request
      function pollCookieFor(ms = 3000, interval = 300) {
        const start = Date.now();
        let last = getDatadomeCookie();
        updateCookiePanel();
        const t = setInterval(() => {
          const now = getDatadomeCookie();
          if (now !== last) {
            last = now;
            updateCookiePanel();
          }
          if (Date.now() - start >= ms) clearInterval(t);
        }, interval);
      }

      // XHR to /any-xhr; show headers plus the two cookie views
      async function callAnyXhr() {
        const output = document.getElementById("output");
        output.textContent = "Loading...";
        const res = await fetch("/any-xhr");
        const data = await res.json();

        const cookieHeader = data?.requestHeaders?.cookie || "";
        const serverCookies = parseCookieString(cookieHeader);
        const sentWithRequest = serverCookies.datadome ? decodeURIComponent(serverCookies.datadome) : "";
        const afterResponse = getDatadomeCookie(); // cookie visible on the page right after the call

        output.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">Request Headers</h3>
          <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.requestHeaders)}</div>

          <h3 class="text-lg font-semibold mt-4 mb-2">Response Headers</h3>
          <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.responseHeaders)}</div>

          <div class="mt-4 p-3 rounded bg-white border">
            <div class="font-semibold mb-1">datadome cookie sent with request:</div>
            <div class="bg-slate-100 p-2 rounded break-all">${sentWithRequest || "(none)"}</div>

            <div class="font-semibold mt-3 mb-1">datadome cookie after response:</div>
            <div class="bg-slate-100 p-2 rounded break-all">${afterResponse || "(none)"}</div>
          </div>
        `;

        // Refresh cookie panel and watch briefly for any post-response updates
        pollCookieFor(3000, 300);
      }

      // Wire up
      document.getElementById("removeCookieBtn").addEventListener("click", removeCookie);
      document.getElementById("xhrButton").addEventListener("click", callAnyXhr);

      // Initial panel (and quick re-check shortly after load)
      document.addEventListener("DOMContentLoaded", () => {
        updateCookiePanel();
        setTimeout(updateCookiePanel, 500);
      });
    </script>
  </body>
</html>
