<!-- public/index.html -->
<!doctype html>
<html lang="en" class="h-full w-full">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- DataDome tag FIRST (standard, minimal; no async) -->
    <script>
      window.ddjskey = '5937CB836686F83D473E0A7011FA0E';
      window.ddoptions = { withCredentials: true };
    </script>
    <script src="https://js.datadome.co/tags.js"></script>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <title>DataDome Protected Page</title>
  </head>
  <body class="h-full w-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900">
    <main class="mx-auto w-full max-w-screen-lg px-4 sm:px-6 lg:px-8 py-8">
      <header class="mb-8 text-center">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-700 leading-tight">
          DataDome Protection Demo
        </h1>
        <p class="mt-2 text-base sm:text-lg text-slate-600">
          This page is protected by DataDome (server + client).
        </p>
      </header>

      <section class="grid gap-6 md:grid-cols-2">
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow">
          <h2 class="text-lg sm:text-xl font-semibold mb-3">DataDome Cookie (full value)</h2>
          <pre id="cookieBox" class="bg-slate-100 p-3 rounded overflow-x-auto text-xs sm:text-sm break-words">(No datadome cookie set)</pre>

          <div class="mt-4 space-y-2 text-sm">
            <div>
              <span class="font-semibold text-slate-700">Current User-Agent (client):</span>
              <div id="uaBox" class="mt-1 bg-slate-100 p-2 rounded break-words text-xs sm:text-sm">(loading…)</div>
            </div>
          </div>

          <button
            id="removeCookieBtn"
            class="mt-4 rounded bg-red-600 px-3 py-1.5 text-white hover:bg-red-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Remove Cookie
          </button>
        </div>

        <div class="bg-white p-4 sm:p-6 rounded-xl shadow">
          <h2 class="text-lg sm:text-xl font-semibold mb-3">Client-side Integration Snippet</h2>
          <pre class="bg-slate-100 p-3 rounded overflow-x-auto text-xs sm:text-sm">
&lt;script&gt;
  window.ddjskey = '5937CB836686F83D473E0A7011FA0E';
  window.ddoptions = { withCredentials: true };
&lt;/script&gt;
&lt;script src="https://js.datadome.co/tags.js"&gt;&lt;/script&gt;
          </pre>
        </div>
      </section>

      <section class="mt-10">
        <h2 class="text-2xl font-semibold mb-4">Test Endpoints</h2>
        <div class="flex flex-wrap gap-3">
          <button
            id="xhrButton"
            type="button"
            class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
          >
            Trigger XHR to /any-xhr
          </button>

          <!-- Cross-Origin button: calls HTTPS subdomain -->
          <button
            id="crossButton"
            type="button"
            class="rounded-lg bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700"
          >
            Trigger Cross-Origin XHR to api.localhost/cross-origin-xhr
          </button>

          <a
            href="/any-document"
            class="rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700 inline-block"
          >
            Navigate to /any-document
          </a>
        </div>

        <div id="output" class="mt-6 p-4 border rounded bg-white shadow text-sm"></div>
      </section>

      <section class="mt-10 bg-white p-4 sm:p-6 rounded-xl shadow">
        <h2 class="text-lg sm:text-xl font-semibold mb-3">Challenge triggers (set User-Agent)</h2>
        <ul class="list-disc pl-6 space-y-1 text-slate-800 text-sm sm:text-base">
          <li><code>BLOCKUA</code> → CAPTCHA</li>
          <li><code>BLOCKUA-HARDBLOCK</code> → CAPTCHA then HARDBLOCK</li>
          <li><code>DeviceCheckTestUA</code> → DeviceCheck</li>
          <li><code>DeviceCheckTestUA-BLOCKUA</code> → DeviceCheck then CAPTCHA</li>
          <li><code>DeviceCheckTestUA-HARDBLOCK</code> → DeviceCheck then HARDBLOCK</li>
          <li><code>HARDBLOCKUA</code> → HARDBLOCK</li>
          <li><code>HARDBLOCK_UA</code> → HARDBLOCK on XHR on Cross-Domain</li>
        </ul>
      </section>
    </main>

    <script>
      // --- Cookie helpers ---
      function parseCookieString(s) {
        const out = {};
        (s || "").split(";").forEach((part) => {
          const [k, ...rest] = part.trim().split("=");
          if (!k) return;
          out[k] = rest.join("=");
        });
        return out;
      }
      function getDatadomeCookie() {
        const c = parseCookieString(document.cookie).datadome;
        return c ? decodeURIComponent(c) : "";
      }
      function updateCookiePanel() {
        const val = getDatadomeCookie();
        const box = document.getElementById("cookieBox");
        const btn = document.getElementById("removeCookieBtn");
        if (val) {
          box.textContent = val;
          btn.disabled = false;
        } else {
          box.textContent = "(No datadome cookie set)";
          btn.disabled = true;
        }
      }
      function removeCookie() {
        const name = "datadome";
        const expires = "Thu, 01 Jan 1970 00:00:00 GMT";
        const host = location.hostname;
        const del = (domain, path) => {
          document.cookie =
            `${name}=; Expires=${expires}; Max-Age=0; Path=${path}` +
            (domain ? `; Domain=${domain}` : "") +
            (location.protocol === "https:" ? "; Secure" : "") +
            "; SameSite=Lax";
        };
        const bare = host.replace(/^www\./, "");
        const domains = ["", host, `.${host}`, bare !== host ? bare : "", bare !== host ? `.${bare}` : ""].filter(Boolean);
        const pathParts = location.pathname.split("/").filter(Boolean);
        const paths = ["/", `/${pathParts.slice(0, -1).join("/")}` || "/"];
        for (const d of domains) for (const p of paths) del(d, p);
        updateCookiePanel();
      }

      // Render headers
      function renderHeaders(obj) {
        return Object.entries(obj || {})
          .map(([k, v]) => `<div><span class="text-blue-700 font-semibold">${k}:</span> <span class="text-slate-800 break-all">${v}</span></div>`)
          .join("");
      }

      // Short poll for cookie updates after requests
      function pollCookieFor(ms = 3000, interval = 300) {
        const start = Date.now();
        let last = getDatadomeCookie();
        updateCookiePanel();
        const t = setInterval(() => {
          const now = getDatadomeCookie();
          if (now !== last) {
            last = now;
            updateCookiePanel();
          }
          if (Date.now() - start >= ms) clearInterval(t);
        }, interval);
      }

      // Same-origin XHR
      async function callAnyXhr() {
        const output = document.getElementById("output");
        output.textContent = "Loading...";
        const res = await fetch("/any-xhr");
        const data = await res.json();

        output.innerHTML = `
          <h3 class="text-lg font-semibold mb-2">Request Headers</h3>
          <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.requestHeaders)}</div>

          <h3 class="text-lg font-semibold mt-4 mb-2">Response Headers</h3>
          <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.responseHeaders)}</div>
        `;
        pollCookieFor(3000, 300);
      }

      // Cross-origin XHR → HTTPS subdomain
      async function callCrossOrigin() {
        const output = document.getElementById("output");
        output.textContent = "Loading cross-origin request...";
        try {
          const res = await fetch('https://api.localhost:3443/cross-origin-xhr', { mode: 'cors',  credentials: 'include' });
          const data = await res.json();

          output.innerHTML = `
            <h3 class="text-lg font-semibold mb-2">[Cross-Origin] Request Headers</h3>
            <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.requestHeaders)}</div>

            <h3 class="text-lg font-semibold mt-4 mb-2">[Cross-Origin] Response Headers</h3>
            <div class="bg-slate-100 p-3 rounded shadow space-y-1">${renderHeaders(data.responseHeaders)}</div>
          `;
        } catch (e) {
          output.textContent = "Cross-origin call failed: " + e.message;
        }
        pollCookieFor(3000, 300);
      }

      // Dynamic UA (updates on focus/visibility)
      function updateUABox() {
        document.getElementById('uaBox').textContent = navigator.userAgent || '';
      }

      // Wire up
      document.getElementById("removeCookieBtn").addEventListener("click", removeCookie);
      document.getElementById("xhrButton").addEventListener("click", () => { callAnyXhr(); updateUABox(); });
      document.getElementById("crossButton").addEventListener("click", () => { callCrossOrigin(); updateUABox(); });

      document.addEventListener("DOMContentLoaded", () => {
        updateCookiePanel();
        updateUABox();
        setTimeout(updateCookiePanel, 500);
      });
      window.addEventListener('focus', updateUABox);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) updateUABox(); });
    </script>
  </body>
</html>
